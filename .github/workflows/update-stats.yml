# ============================================================================
# GITHUB STATS AUTO-UPDATE WORKFLOW
# ============================================================================
# Purpose: Downloads and caches GitHub statistics cards with radical theme
# Author: Festo Wampamba
# Timezone: EAT (Uganda - UTC+3)
# Update Schedule: Daily at 2:00 AM EAT
# ============================================================================

name: Update GitHub Stats

# ============================================================================
# WORKFLOW TRIGGERS
# ============================================================================
on:
  # Runs daily at 2:00 AM EAT (11:00 PM UTC previous day)
  schedule:
    - cron: '0 23 * * *'
  
  # Allows manual trigger from GitHub Actions tab
  workflow_dispatch:
  
  # Runs when workflow file is modified
  push:
    branches: [ main ]
    paths: [ '.github/workflows/update-stats.yml' ]

# ============================================================================
# PERMISSIONS
# ============================================================================
permissions:
  contents: write  # Required to commit SVG files to repository

# ============================================================================
# JOBS
# ============================================================================
jobs:
  update-stats:
    name: Generate GitHub Statistics Cards
    runs-on: ubuntu-latest
    
    steps:
      # =======================================================================
      # STEP 1: CHECKOUT REPOSITORY
      # =======================================================================
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for accurate statistics

      # =======================================================================
      # STEP 2: CREATE ASSETS DIRECTORY
      # =======================================================================
      - name: Create Assets Directory
        run: mkdir -p assets

      # =======================================================================
      # STEP 3: DOWNLOAD GITHUB STATS CARD (RADICAL THEME)
      # =======================================================================
      # Downloads main GitHub statistics card with:
      # - Username: Festo-Wampamba
      # - Theme: Radical (pink/magenta gradient)
      # - Shows icons for each stat
      # - Includes all commits (not just current year)
      # - Includes private repository stats
      # - No border hiding
      # =======================================================================
      - name: Download GitHub Stats Card
        run: |
          echo "ðŸ“Š Downloading GitHub Stats Card..."
          curl -L -f --retry 5 --retry-delay 3 --max-time 60 \
            -H "Accept: image/svg+xml" \
            -o assets/github-stats-radical.svg \
            "https://github-readme-stats.vercel.app/api?username=Festo-Wampamba&show_icons=true&theme=radical&hide_border=false&include_all_commits=true&count_private=true&cache_seconds=86400" \
            || echo "âš ï¸  Stats card download failed, keeping previous version"
        continue-on-error: true

      # =======================================================================
      # STEP 4: DOWNLOAD GITHUB STREAK CARD (RADICAL THEME)
      # =======================================================================
      # Downloads contribution streak statistics with:
      # - Current streak counter
      # - Longest streak record
      # - Total contributions
      # - Radical theme to match stats card
      # =======================================================================
      - name: Download GitHub Streak Card
        run: |
          echo "ðŸ”¥ Downloading GitHub Streak Card..."
          curl -L -f --retry 5 --retry-delay 3 --max-time 60 \
            -H "Accept: image/svg+xml" \
            -o assets/github-streak-radical.svg \
            "https://github-readme-streak-stats.herokuapp.com/?user=Festo-Wampamba&theme=radical&hide_border=false" \
            || echo "âš ï¸  Streak card download failed, keeping previous version"
        continue-on-error: true

      # =======================================================================
      # STEP 5: DOWNLOAD TOP LANGUAGES CARD (RADICAL THEME)
      # =======================================================================
      # Downloads most used programming languages with:
      # - Compact layout (horizontal bars)
      # - Shows top 10 languages
      # - Includes private repos
      # - Excludes HTML/CSS by default for cleaner view
      # =======================================================================
      - name: Download Top Languages Card
        run: |
          echo "ðŸ’» Downloading Top Languages Card..."
          curl -L -f --retry 5 --retry-delay 3 --max-time 60 \
            -H "Accept: image/svg+xml" \
            -o assets/top-languages-radical.svg \
            "https://github-readme-stats.vercel.app/api/top-langs/?username=Festo-Wampamba&theme=radical&hide_border=false&include_all_commits=true&count_private=true&layout=compact&langs_count=10&hide=html,css&card_width=445" \
            || echo "âš ï¸  Languages card download failed, keeping previous version"
        continue-on-error: true

      # =======================================================================
      # STEP 6: VALIDATE DOWNLOADED SVG FILES
      # =======================================================================
      # Checks if SVG files were downloaded successfully and contain valid data
      # If files are empty or contain error messages, they won't be committed
      # =======================================================================
      - name: Validate SVG Files
        run: |
          echo "âœ… Validating downloaded SVG files..."
          
          # Function to check if SVG is valid
          validate_svg() {
            local file=$1
            if [ -f "$file" ]; then
              local size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
              if [ "$size" -gt 1000 ]; then
                if grep -q "<svg" "$file" && ! grep -q "503" "$file"; then
                  echo "  âœ“ $file is valid (${size} bytes)"
                  return 0
                fi
              fi
            fi
            echo "  âœ— $file is invalid or too small"
            return 1
          }
          
          # Validate each SVG file
          validate_svg "assets/github-stats-radical.svg" || true
          validate_svg "assets/github-streak-radical.svg" || true
          validate_svg "assets/top-languages-radical.svg" || true
          
          echo "Validation complete!"

      # =======================================================================
      # STEP 7: COMMIT AND PUSH UPDATED SVG FILES
      # =======================================================================
      # Commits the downloaded SVG files to the repository
      # Only commits if files have changed
      # Uses [skip ci] to prevent recursive workflow triggers
      # =======================================================================
      - name: Commit and Push Stats
        run: |
          # Configure git with GitHub Actions bot credentials
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Add all SVG files in assets directory
          git add assets/*.svg
          
          # Check if there are any changes to commit
          if git diff --staged --quiet; then
            echo "ðŸ“­ No changes to commit - SVG files are up to date"
          else
            # Commit with descriptive message and skip CI flag
            git commit -m "Auto-update: GitHub stats (Radical theme) [skip ci]" \
                       -m "Updated at: $(date '+%Y-%m-%d %H:%M:%S EAT')" \
                       -m "Cards: Stats, Streak, Languages"
            
            # Push changes to main branch
            git push
            
            echo "âœ… Successfully committed and pushed updated stats!"
          fi
