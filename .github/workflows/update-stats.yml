# ============================================================================
# GITHUB STATS AUTO-UPDATE WORKFLOW (SELF-HOSTED VERCEL)
# ============================================================================
# Purpose: Downloads stats from your own Vercel deployment
# Author: Festo Wampamba
# Deployment: github-readme-stats-three-azure-32.vercel.app
# Timezone: EAT
# ============================================================================

name: Update GitHub Stats

on:
  schedule:
    - cron: '0 23 * * *'  # Daily at 2 AM EAT
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: [ '.github/workflows/update-stats.yml' ]

permissions:
  contents: write

# ============================================================================
# ENVIRONMENT VARIABLES
# ============================================================================
env:
  # ğŸš€ YOUR VERCEL DEPLOYMENT URL
  STATS_API: "https://github-readme-stats-three-azure-32.vercel.app"
  GITHUB_USER: "Festo-Wampamba"
  THEME: "radical"

# ============================================================================
# JOBS
# ============================================================================
jobs:
  update-stats:
    name: Generate GitHub Statistics from Self-Hosted Instance
    runs-on: ubuntu-latest
    
    steps:
      # =======================================================================
      # CHECKOUT REPOSITORY
      # =======================================================================
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =======================================================================
      # CREATE ASSETS DIRECTORY
      # =======================================================================
      - name: Create Assets Directory
        run: mkdir -p assets

      # =======================================================================
      # DOWNLOAD STATS CARD FROM YOUR VERCEL INSTANCE
      # =======================================================================
      - name: Download GitHub Stats Card
        run: |
          echo "ğŸ“Š Downloading GitHub Stats from self-hosted instance..."
          echo "URL: ${{ env.STATS_API }}/api"
          
          curl -L -f \
            --retry 3 \
            --retry-delay 2 \
            --max-time 30 \
            -H "Accept: image/svg+xml" \
            -o assets/github-stats-radical.svg \
            "${{ env.STATS_API }}/api?username=${{ env.GITHUB_USER }}&show_icons=true&theme=${{ env.THEME }}&hide_border=false&include_all_commits=true&count_private=true" \
            && echo "âœ… Stats card downloaded!" \
            || { echo "âŒ Failed to download stats card"; exit 1; }

      # =======================================================================
      # DOWNLOAD STREAK CARD (EXTERNAL SERVICE)
      # =======================================================================
      - name: Download GitHub Streak Card
        run: |
          echo "ğŸ”¥ Downloading GitHub Streak card..."
          
          curl -L -f \
            --retry 3 \
            --retry-delay 2 \
            --max-time 30 \
            -H "Accept: image/svg+xml" \
            -o assets/github-streak-radical.svg \
            "https://github-readme-streak-stats.herokuapp.com/?user=${{ env.GITHUB_USER }}&theme=${{ env.THEME }}&hide_border=false" \
            && echo "âœ… Streak card downloaded!" \
            || { echo "âŒ Failed to download streak card"; exit 1; }

      # =======================================================================
      # DOWNLOAD TOP LANGUAGES FROM YOUR VERCEL INSTANCE
      # =======================================================================
      - name: Download Top Languages Card
        run: |
          echo "ğŸ’» Downloading Top Languages from self-hosted instance..."
          
          curl -L -f \
            --retry 3 \
            --retry-delay 2 \
            --max-time 30 \
            -H "Accept: image/svg+xml" \
            -o assets/top-languages-radical.svg \
            "${{ env.STATS_API }}/api/top-langs/?username=${{ env.GITHUB_USER }}&theme=${{ env.THEME }}&hide_border=false&layout=compact&langs_count=10&hide=html,css&card_width=445" \
            && echo "âœ… Languages card downloaded!" \
            || { echo "âŒ Failed to download languages card"; exit 1; }

      # =======================================================================
      # VERIFY ALL FILES DOWNLOADED SUCCESSFULLY
      # =======================================================================
      - name: Verify Downloaded Files
        run: |
          echo "ğŸ” Verifying downloaded SVG files..."
          
          for file in assets/github-stats-radical.svg assets/github-streak-radical.svg assets/top-languages-radical.svg; do
            if [ -f "$file" ]; then
              size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
              if [ "$size" -gt 1000 ]; then
                echo "  âœ… $file (${size} bytes)"
              else
                echo "  âš ï¸  $file is too small (${size} bytes)"
              fi
            else
              echo "  âŒ $file not found"
            fi
          done

      # =======================================================================
      # COMMIT AND PUSH TO REPOSITORY
      # =======================================================================
      - name: Commit and Push Stats
        run: |
          echo "ğŸ’¾ Committing changes..."
          
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add assets/*.svg
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ No changes to commit - stats are up to date"
          else
            git commit -m "Auto-update: GitHub stats (Self-hosted Vercel) [skip ci]" \
                       -m "ğŸ“… Updated: $(date '+%Y-%m-%d %H:%M:%S EAT')" \
                       -m "ğŸš€ Source: github-readme-stats-three-azure-32.vercel.app" \
                       -m "ğŸ¨ Theme: Radical"
            
            git push
            
            echo "âœ… Successfully updated GitHub stats!"
          fi
