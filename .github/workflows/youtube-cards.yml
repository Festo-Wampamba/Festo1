# ============================================================================
# YOUTUBE VIDEOS WITH VIEW COUNTS - WORKING VERSION
# ============================================================================
name: Update YouTube Videos

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-youtube:
    name: Fetch YouTube Videos with Stats
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install google-api-python-client python-dateutil

      - name: Generate YouTube Video Cards
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          CHANNEL_ID: UCSiPOa3Vowwi42t1BysexmQ
        run: |
          cat > update_youtube.py << 'ENDOFPYTHON'
          import os
          import re
          from googleapiclient.discovery import build
          from dateutil import parser

          api_key = os.environ['YOUTUBE_API_KEY']
          channel_id = os.environ['CHANNEL_ID']
          youtube = build('youtube', 'v3', developerKey=api_key)

          channel_response = youtube.channels().list(
              part='contentDetails',
              id=channel_id
          ).execute()
          
          uploads_playlist_id = channel_response['items'][0]['contentDetails']['relatedPlaylists']['uploads']

          videos_response = youtube.playlistItems().list(
              part='snippet',
              playlistId=uploads_playlist_id,
              maxResults=50
          ).execute()

          video_ids = [item['snippet']['resourceId']['videoId'] for item in videos_response['items']]

          stats_response = youtube.videos().list(
              part='statistics,contentDetails',
              id=','.join(video_ids)
          ).execute()

          videos = []
          for item in stats_response['items']:
              video_id = item['id']
              stats = item['statistics']
              duration = item['contentDetails']['duration']
              
              snippet = next(v['snippet'] for v in videos_response['items'] 
                           if v['snippet']['resourceId']['videoId'] == video_id)
              
              duration_match = re.findall(r'(\d+)([HMS])', duration)
              seconds = sum(int(num) * {'H': 3600, 'M': 60, 'S': 1}[unit] for num, unit in duration_match)
              
              published_at = parser.parse(snippet['publishedAt'])

              videos.append({
                  'id': video_id,
                  'title': snippet['title'],
                  'views': int(stats.get('viewCount', 0)),
                  'published': published_at,
                  'duration': seconds
              })

          latest_videos = sorted(videos, key=lambda x: x['published'], reverse=True)[:4]
          most_viewed = sorted(videos, key=lambda x: x['views'], reverse=True)[:2]

          def format_views(views):
              if views >= 1000000:
                  return "{:.1f}M".format(views/1000000)
              elif views >= 1000:
                  return "{:.1f}K".format(views/1000)
              return str(views)

          def generate_card(video):
              video_id = video['id']
              title = video['title'].replace(' ', '+').replace('&', 'and')
              views_formatted = format_views(video['views'])
              timestamp = int(video['published'].timestamp())
              duration = video['duration']
              
              title_with_views = "{} | {} views".format(title[:40], views_formatted)
              
              card_url = "https://ytcards.demolab.com/?id={}&title={}&lang=en&timestamp={}&background_color=%230d1117&title_color=%23ffffff&stats_color=%23dedede&max_title_lines=2&width=250&border_radius=5&duration={}".format(
                  video_id, title_with_views, timestamp, duration
              )
              
              return '<a href="https://www.youtube.com/watch?v={}"><img src="{}" alt="{}" /></a>'.format(
                  video_id, card_url, video['title']
              )

          latest_cards = '\n  '.join([generate_card(v) for v in latest_videos])
          popular_cards = '\n  '.join([generate_card(v) for v in most_viewed])

          markdown = """### ðŸŽ¬ Latest Videos

<p align="center">
  {}
</p>

### ðŸ”¥ Most Viewed Videos

<p align="center">
  {}
</p>""".format(latest_cards, popular_cards)

          with open('README.md', 'r', encoding='utf-8') as f:
              content = f.read()

          pattern = r'<!-- BEGIN YOUTUBE-CARDS -->.*?<!-- END YOUTUBE-CARDS -->'
          replacement = '<!-- BEGIN YOUTUBE-CARDS -->\n{}\n<!-- END YOUTUBE-CARDS -->'.format(markdown)
          
          new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)

          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(new_content)

          print("âœ… YouTube videos updated successfully!")
          print("ðŸ“Š Latest 4 videos added")
          print("ðŸ”¥ Top 2 most viewed videos added")
          ENDOFPYTHON

          python3 update_youtube.py

      - name: Commit Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "ðŸ“­ No changes to commit"
          else
            git commit -m "Auto-update: YouTube videos [skip ci]"
            git push
            echo "âœ… Changes pushed successfully!"
          fi
