# ============================================================================
# LIGHTWEIGHT YOUTUBE AUTOMATION
# ============================================================================
name: Update YouTube Videos

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-youtube:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install google-api-python-client python-dateutil

      - name: Create & Run Script
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          CHANNEL_ID: UCSiPOa3Vowwi42t1BysexmQ
        run: |
          cat << 'EOF' > update.py
          import os, re
          from googleapiclient.discovery import build
          from dateutil import parser

          def main():
              api = os.environ.get('YOUTUBE_API_KEY')
              cid = os.environ.get('CHANNEL_ID')
              if not api or not cid: return

              yt = build('youtube', 'v3', developerKey=api)
              
              # 1. Get Uploads Playlist
              try:
                  ch = yt.channels().list(part='contentDetails', id=cid).execute()
                  uploads_id = ch['items'][0]['contentDetails']['relatedPlaylists']['uploads']
              except: return

              # 2. Get Videos & Stats
              vid_resp = yt.playlistItems().list(part='snippet', playlistId=uploads_id, maxResults=10).execute()
              vid_ids = [i['snippet']['resourceId']['videoId'] for i in vid_resp['items']]
              stats_resp = yt.videos().list(part='statistics,contentDetails', id=','.join(vid_ids)).execute()

              # 3. Process Data
              videos = []
              for item in stats_resp['items']:
                  vid_id = item['id']
                  stats = item['statistics']
                  duration_str = item['contentDetails']['duration']
                  snippet = next(v['snippet'] for v in vid_resp['items'] if v['snippet']['resourceId']['videoId'] == vid_id)
                  
                  # Parse duration (simple)
                  match = re.findall(r'(\d+)([HMS])', duration_str)
                  sec = sum(int(n) * {'H':3600,'M':60,'S':1}[u] for n,u in match)

                  videos.append({
                      'id': vid_id,
                      'title': snippet['title'],
                      'views': int(stats.get('viewCount', 0)),
                      'date': parser.parse(snippet['publishedAt']),
                      'dur': sec
                  })

              # 4. Sort & Select
              latest = sorted(videos, key=lambda x: x['date'], reverse=True)[:4]
              popular = sorted(videos, key=lambda x: x['views'], reverse=True)[:2]

              # 5. Generate Markdown
              def card(v):
                  # Clean title for URL
                  t = v['title'].replace('|','').replace('"','').replace("'",'').replace(' ','+')[:50]
                  # Format views (1.2K)
                  views = f"{v['views']/1000000:.1f}M" if v['views']>=1M else (f"{v['views']/1000:.1f}K" if v['views']>=1000 else str(v['views']))
                  
                  url = f"https://ytcards.demolab.com/?id={v['id']}&title={t}+%7C+{views}&lang=en&timestamp={int(v['date'].timestamp())}&background_color=%230d1117&title_color=%23ffffff&stats_color=%23dedede&max_title_lines=1&width=250&border_radius=5&duration={v['dur']}"
                  return f'<a href="https://www.youtube.com/watch?v={v["id"]}"><img src="{url}" alt="{v["title"]}" /></a>'

              # Layout: Latest (Grid) + Popular (Grid)
              # Using <br/> to ensure they don't stack weirdly
              md = "### ðŸŽ¬ Latest Videos\n" + " ".join([card(v) for v in latest]) + "\n\n### ðŸ”¥ Most Viewed\n" + " ".join([card(v) for v in popular])

              # 6. Update README
              with open('README.md', 'r+') as f:
                  content = f.read()
                  new_content = re.sub(r'.*?', 
                                     f'\n{md}\n', 
                                     content, flags=re.DOTALL)
                  f.seek(0); f.write(new_content); f.truncate()
          
          if __name__ == "__main__": main()
          EOF
          
          python3 update.py

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "bot@noreply.github.com"
          git add README.md
          git commit -m "update youtube stats" || echo "No changes"
          git push
